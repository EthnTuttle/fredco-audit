<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Playground - Open Frederick</title>
    
    <!-- Monaco Editor -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/editor/editor.main.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- AlaSQL for SQL queries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/4.1.0/alasql.min.js"></script>
    
    <style>
        :root {
            --primary: #1e40af;
            --primary-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --purple: #7c3aed;
            --purple-light: #a78bfa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-900);
            color: var(--gray-100);
            line-height: 1.6;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--gray-800) 0%, var(--gray-900) 100%);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--gray-700);
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: white;
        }

        .logo span {
            font-size: 0.8rem;
            color: var(--gray-400);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--purple);
            color: white;
        }

        .btn-primary:hover {
            background: var(--purple-light);
        }

        .btn-secondary {
            background: var(--gray-700);
            color: var(--gray-200);
        }

        .btn-secondary:hover {
            background: var(--gray-600);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--gray-600);
            color: var(--gray-300);
        }

        .btn-outline:hover {
            background: var(--gray-800);
            border-color: var(--gray-500);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--gray-800);
            border-right: 1px solid var(--gray-700);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--gray-700);
        }

        .sidebar-header h2 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .data-category {
            margin-bottom: 15px;
        }

        .category-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 5px 10px;
            margin-bottom: 5px;
        }

        .data-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
            margin-bottom: 2px;
        }

        .data-item:hover {
            background: var(--gray-700);
        }

        .data-item.active {
            background: var(--purple);
        }

        .data-item.loaded {
            border-left: 3px solid var(--success);
        }

        .data-item-name {
            font-size: 0.875rem;
            color: var(--gray-200);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .data-item-size {
            font-size: 0.75rem;
            color: var(--gray-500);
            flex-shrink: 0;
        }

        .data-item.large .data-item-size {
            color: var(--warning);
        }

        /* Workspace */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Tabs */
        .tab-bar {
            display: flex;
            background: var(--gray-800);
            border-bottom: 1px solid var(--gray-700);
            padding: 0 10px;
            flex-shrink: 0;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--gray-400);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            color: var(--gray-200);
            background: var(--gray-700);
        }

        .tab.active {
            color: white;
            border-bottom-color: var(--purple);
        }

        .tab-icon {
            font-size: 1rem;
        }

        /* Panels */
        .panels-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .panel {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .panel.active {
            display: flex;
        }

        /* Data Browser Panel */
        .data-browser {
            padding: 20px;
            overflow: auto;
        }

        .json-viewer {
            background: var(--gray-800);
            border-radius: 8px;
            padding: 15px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 0.875rem;
            overflow: auto;
            max-height: calc(100vh - 250px);
        }

        .json-key { color: #7dd3fc; }
        .json-string { color: #86efac; }
        .json-number { color: #fca5a5; }
        .json-boolean { color: #c4b5fd; }
        .json-null { color: var(--gray-500); }
        .json-bracket { color: var(--gray-400); }

        .json-collapsible {
            cursor: pointer;
            user-select: none;
        }

        .json-collapsible::before {
            content: '‚ñº';
            display: inline-block;
            width: 15px;
            font-size: 0.7rem;
            color: var(--gray-500);
        }

        .json-collapsible.collapsed::before {
            content: '‚ñ∂';
        }

        .json-collapsible.collapsed + .json-children {
            display: none;
        }

        .json-children {
            margin-left: 20px;
        }

        /* SQL Panel */
        .sql-panel {
            display: flex;
            flex-direction: column;
        }

        .sql-toolbar {
            padding: 10px 15px;
            background: var(--gray-800);
            border-bottom: 1px solid var(--gray-700);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sql-editor-container {
            height: 200px;
            border-bottom: 1px solid var(--gray-700);
        }

        .sql-results {
            flex: 1;
            overflow: auto;
            padding: 15px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .results-table th,
        .results-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-700);
        }

        .results-table th {
            background: var(--gray-800);
            font-weight: 600;
            color: var(--gray-300);
            position: sticky;
            top: 0;
        }

        .results-table tr:hover {
            background: var(--gray-800);
        }

        /* Python Panel */
        .python-panel {
            display: flex;
            flex-direction: column;
        }

        .python-toolbar {
            padding: 10px 15px;
            background: var(--gray-800);
            border-bottom: 1px solid var(--gray-700);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .python-status {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-left: auto;
        }

        .python-status.ready {
            color: var(--success);
        }

        .python-status.loading {
            color: var(--warning);
        }

        .notebook-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .cell {
            background: var(--gray-800);
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid var(--gray-700);
        }

        .cell.active {
            border-color: var(--purple);
        }

        .cell-toolbar {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid var(--gray-700);
            gap: 10px;
        }

        .cell-type {
            font-size: 0.75rem;
            color: var(--gray-500);
            text-transform: uppercase;
        }

        .cell-actions {
            margin-left: auto;
            display: flex;
            gap: 5px;
        }

        .cell-btn {
            padding: 4px 8px;
            background: var(--gray-700);
            border: none;
            border-radius: 4px;
            color: var(--gray-300);
            cursor: pointer;
            font-size: 0.75rem;
        }

        .cell-btn:hover {
            background: var(--gray-600);
        }

        .cell-btn.run {
            background: var(--success);
            color: white;
        }

        .cell-editor {
            min-height: 100px;
        }

        .cell-output {
            padding: 12px;
            background: var(--gray-900);
            border-top: 1px solid var(--gray-700);
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow: auto;
        }

        .cell-output.error {
            color: #fca5a5;
        }

        .cell-output:empty {
            display: none;
        }

        /* Chart Panel */
        .chart-panel {
            padding: 20px;
            overflow: auto;
        }

        .chart-container {
            background: var(--gray-800);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Loading States */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-700);
            border-top-color: var(--purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Status Bar */
        .status-bar {
            background: var(--gray-800);
            border-top: 1px solid var(--gray-700);
            padding: 6px 15px;
            font-size: 0.75rem;
            color: var(--gray-500);
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--gray-600);
        }

        .status-dot.connected {
            background: var(--success);
        }

        /* Query Templates */
        .templates-dropdown {
            position: relative;
        }

        .templates-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--gray-800);
            border: 1px solid var(--gray-700);
            border-radius: 6px;
            padding: 5px 0;
            min-width: 250px;
            z-index: 50;
            display: none;
        }

        .templates-menu.show {
            display: block;
        }

        .template-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .template-item:hover {
            background: var(--gray-700);
        }

        /* Hidden file input */
        .hidden-input {
            display: none;
        }

        /* Download Dialog */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .dialog {
            background: var(--gray-800);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--gray-700);
        }

        .dialog h3 {
            margin-bottom: 15px;
            color: white;
        }

        .dialog p {
            color: var(--gray-400);
            margin-bottom: 20px;
        }

        .dialog-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Progress */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-700);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--purple);
            transition: width 0.3s;
        }

        /* Add Cell Button */
        .add-cell-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border: 2px dashed var(--gray-700);
            border-radius: 8px;
            color: var(--gray-500);
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-cell-btn:hover {
            border-color: var(--purple);
            color: var(--purple);
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <h1>Data Playground</h1>
            <span>Open Frederick County Data</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" onclick="loadNotebook()">
                <span>Load</span>
            </button>
            <button class="btn btn-outline" onclick="saveNotebook()">
                <span>Save</span>
            </button>
            <a href="index.html" class="btn btn-secondary">Back to Site</a>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar: Data Files -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Available Data</h2>
            </div>
            <div class="data-list" id="data-list">
                <!-- Populated by JavaScript -->
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="workspace">
            <!-- Tab Bar -->
            <div class="tab-bar">
                <div class="tab active" data-tab="browser">
                    <span class="tab-icon">üìÇ</span>
                    <span>Data Browser</span>
                </div>
                <div class="tab" data-tab="sql">
                    <span class="tab-icon">üîç</span>
                    <span>SQL Query</span>
                </div>
                <div class="tab" data-tab="python">
                    <span class="tab-icon">üêç</span>
                    <span>Python</span>
                </div>
                <div class="tab" data-tab="chart">
                    <span class="tab-icon">üìä</span>
                    <span>Visualize</span>
                </div>
            </div>

            <!-- Panels -->
            <div class="panels-container">
                <!-- Data Browser Panel -->
                <div class="panel active" id="panel-browser">
                    <div class="data-browser">
                        <div id="data-info" style="margin-bottom: 20px;">
                            <h3 style="color: var(--gray-300); margin-bottom: 10px;">Select a dataset from the sidebar</h3>
                            <p style="color: var(--gray-500);">Click on any dataset to preview its contents. You can download individual files or load them into the SQL/Python environments for analysis.</p>
                        </div>
                        <div class="json-viewer" id="json-viewer">
                            <!-- JSON preview will appear here -->
                        </div>
                    </div>
                </div>

                <!-- SQL Query Panel -->
                <div class="panel" id="panel-sql">
                    <div class="sql-panel">
                        <div class="sql-toolbar">
                            <button class="btn btn-primary" onclick="runSQL()">
                                <span>‚ñ∂ Run Query</span>
                            </button>
                            <div class="templates-dropdown">
                                <button class="btn btn-secondary" onclick="toggleTemplates()">
                                    Templates ‚ñº
                                </button>
                                <div class="templates-menu" id="templates-menu">
                                    <div class="template-item" onclick="useTemplate('top_owners')">Top 20 Property Owners</div>
                                    <div class="template-item" onclick="useTemplate('llc_by_district')">LLC Count by District</div>
                                    <div class="template-item" onclick="useTemplate('value_by_class')">Value by Property Class</div>
                                    <div class="template-item" onclick="useTemplate('year_comparison')">Year-over-Year Comparison</div>
                                    <div class="template-item" onclick="useTemplate('high_value')">High Value Properties (>$1M)</div>
                                </div>
                            </div>
                            <span style="color: var(--gray-500); font-size: 0.8rem; margin-left: auto;">
                                Loaded tables: <span id="loaded-tables">none</span>
                            </span>
                        </div>
                        <div class="sql-editor-container" id="sql-editor-container"></div>
                        <div class="sql-results" id="sql-results">
                            <p style="color: var(--gray-500);">Run a query to see results. Load data files from the sidebar first.</p>
                        </div>
                    </div>
                </div>

                <!-- Python Panel -->
                <div class="panel" id="panel-python">
                    <div class="python-panel">
                        <div class="python-toolbar">
                            <button class="btn btn-primary" onclick="runAllCells()">
                                ‚ñ∂ Run All
                            </button>
                            <button class="btn btn-secondary" onclick="addCell()">
                                + Add Cell
                            </button>
                            <button class="btn btn-secondary" onclick="clearOutputs()">
                                Clear Outputs
                            </button>
                            <div class="python-status" id="python-status">
                                Loading Pyodide...
                            </div>
                        </div>
                        <div class="notebook-container" id="notebook-container">
                            <!-- Cells will be added here -->
                        </div>
                    </div>
                </div>

                <!-- Chart Panel -->
                <div class="panel" id="panel-chart">
                    <div class="chart-panel">
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: var(--gray-300); margin-bottom: 10px;">Visualization Builder</h3>
                            <p style="color: var(--gray-500);">Create charts from your SQL query results or Python outputs.</p>
                        </div>
                        <div id="chart-area">
                            <!-- Charts will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-item">
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">Ready</span>
        </div>
        <div class="status-item">
            <span id="memory-usage">Memory: --</span>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="notebook-file-input" class="hidden-input" accept=".json" onchange="handleNotebookUpload(event)">
    <input type="file" id="data-file-input" class="hidden-input" accept=".json" onchange="handleDataUpload(event)">

    <!-- Monaco Editor Loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

    <script>
        // ============================================
        // STATE
        // ============================================
        const state = {
            loadedData: {},        // { tableName: data }
            currentFile: null,
            sqlEditor: null,
            pythonReady: false,
            pyodide: null,
            cells: [],
            cellEditors: {},
            lastSqlResult: null
        };

        // Data file manifest
        const DATA_FILES = [
            { category: 'Property', files: [
                { name: 'real_estate_ownership_analysis', path: 'data/processed/real_estate_ownership_analysis.json', size: '340 KB' },
                { name: 'real_estate_tax_summary', path: 'data/processed/real_estate_tax_summary.json', size: '84 KB' },
                { name: 'real_estate_tax', path: 'data/processed/real_estate_tax.json', size: '212 MB', large: true },
                { name: 'districts_enriched', path: 'data/processed/districts_enriched.geojson', size: '586 KB' },
            ]},
            { category: 'Education', files: [
                { name: 'enrollment', path: 'data/processed/enrollment.json', size: '4 KB' },
                { name: 'expenditures', path: 'data/processed/expenditures.json', size: '12 KB' },
                { name: 'apa_data', path: 'data/processed/apa_data.json', size: '53 KB' },
                { name: 'apa_education_expenditures', path: 'data/processed/apa_education_expenditures.json', size: '11 KB' },
            ]},
            { category: 'Budget', files: [
                { name: 'county_budget_schools', path: 'data/processed/county_budget_schools.json', size: '9 KB' },
                { name: 'county_department_detail', path: 'data/processed/county_department_detail.json', size: '177 KB' },
                { name: 'county_government_analysis', path: 'data/processed/county_government_analysis.json', size: '22 KB' },
            ]},
            { category: 'VDOE', files: [
                { name: 'table8_enrollment', path: 'data/processed/vdoe/table8_enrollment.json', size: '15 KB' },
                { name: 'table15_expenditures', path: 'data/processed/vdoe/table15_expenditures.json', size: '25 KB' },
                { name: 'table17_ratios', path: 'data/processed/vdoe/table17_ratios.json', size: '12 KB' },
                { name: 'table18_admin_personnel', path: 'data/processed/vdoe/table18_admin_personnel.json', size: '45 KB' },
                { name: 'table19_instructional', path: 'data/processed/vdoe/table19_instructional.json', size: '35 KB' },
            ]}
        ];

        // SQL Templates
        const SQL_TEMPLATES = {
            top_owners: `-- Top 20 Property Owners by Value
SELECT owner, entity_type, properties, total_value
FROM real_estate_ownership_analysis.annual_data[4].top_owners_by_value
LIMIT 20`,
            llc_by_district: `-- LLC Count by District
SELECT district, llc_count, llc_pct_records as llc_pct
FROM districts_enriched.features
WHERE properties.tax_data['2025'].ownership IS NOT NULL`,
            value_by_class: `-- Total Value by Property Class
SELECT name, total_count, total_value
FROM real_estate_ownership_analysis.annual_data[4].property_classes`,
            year_comparison: `-- Year-over-Year Value Comparison  
SELECT year, total_records, total_value
FROM real_estate_ownership_analysis.annual_data`,
            high_value: `-- Properties over $1M
SELECT owner, properties, total_value, entity_type
FROM real_estate_ownership_analysis.annual_data[4].top_owners_by_value
WHERE total_value > 1000000`
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initDataList();
            initTabs();
            initMonaco();
            initPyodide();
            addInitialCell();
        });

        function initDataList() {
            const container = document.getElementById('data-list');
            let html = '';
            
            DATA_FILES.forEach(category => {
                html += `<div class="data-category">
                    <div class="category-header">${category.category}</div>`;
                
                category.files.forEach(file => {
                    const largeClass = file.large ? 'large' : '';
                    html += `
                        <div class="data-item ${largeClass}" data-file="${file.name}" data-path="${file.path}" onclick="selectDataFile('${file.name}', '${file.path}', ${file.large || false})">
                            <span class="data-item-name">${file.name}</span>
                            <span class="data-item-size">${file.size}</span>
                        </div>`;
                });
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');
                });
            });
        }

        function initMonaco() {
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
            
            require(['vs/editor/editor.main'], function() {
                // SQL Editor
                state.sqlEditor = monaco.editor.create(document.getElementById('sql-editor-container'), {
                    value: '-- Select a data file and write your SQL query\n-- Tables are named after the file (e.g., real_estate_ownership_analysis)\n\nSELECT * FROM your_table LIMIT 10',
                    language: 'sql',
                    theme: 'vs-dark',
                    minimap: { enabled: false },
                    fontSize: 14,
                    lineNumbers: 'on',
                    scrollBeyondLastLine: false,
                    automaticLayout: true
                });

                // Keyboard shortcut to run query
                state.sqlEditor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, runSQL);
            });
        }

        async function initPyodide() {
            const statusEl = document.getElementById('python-status');
            statusEl.textContent = 'Loading Pyodide...';
            statusEl.className = 'python-status loading';

            try {
                // Load Pyodide
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js';
                document.head.appendChild(script);

                script.onload = async () => {
                    state.pyodide = await loadPyodide();
                    
                    // Install common packages
                    await state.pyodide.loadPackage(['pandas', 'numpy']);
                    
                    // Set up the Python environment
                    await state.pyodide.runPythonAsync(`
import pandas as pd
import numpy as np
import json
from js import loadedDataProxy

def load_data(name):
    """Load a dataset by name into a pandas DataFrame."""
    data = loadedDataProxy(name)
    if data is None:
        raise ValueError(f"Dataset '{name}' not loaded. Load it from the sidebar first.")
    return pd.DataFrame(data) if isinstance(data, list) else data

def show(obj):
    """Display an object nicely."""
    if isinstance(obj, pd.DataFrame):
        return obj.to_string()
    return str(obj)

print("Pandas and NumPy ready!")
print("Use load_data('table_name') to access loaded datasets.")
                    `);
                    
                    state.pythonReady = true;
                    statusEl.textContent = 'Python Ready';
                    statusEl.className = 'python-status ready';
                    setStatus('Pyodide loaded successfully', 'connected');
                };
            } catch (e) {
                statusEl.textContent = 'Python Failed to Load';
                statusEl.className = 'python-status';
                console.error('Pyodide error:', e);
            }
        }

        // Proxy function for Python to access loaded data
        window.loadedDataProxy = (name) => {
            const data = state.loadedData[name];
            if (!data) return null;
            
            // If it's an array, return directly
            if (Array.isArray(data)) return data;
            
            // If it has records, return those
            if (data.records) return data.records;
            if (data.data) return data.data;
            if (data.annual_data) return data.annual_data;
            
            return data;
        };

        // ============================================
        // DATA LOADING
        // ============================================
        async function selectDataFile(name, path, isLarge) {
            // Update UI
            document.querySelectorAll('.data-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-file="${name}"]`)?.classList.add('active');
            
            state.currentFile = name;
            
            // Check if already loaded
            if (state.loadedData[name]) {
                displayData(name, state.loadedData[name]);
                return;
            }
            
            // Warn for large files
            if (isLarge) {
                if (!confirm(`This file is ${path.includes('212') ? '212 MB' : 'large'}. Loading may take a while and use significant memory. Continue?`)) {
                    return;
                }
            }
            
            setStatus(`Loading ${name}...`, 'loading');
            
            try {
                const response = await fetch(path);
                const data = await response.json();
                
                state.loadedData[name] = data;
                document.querySelector(`[data-file="${name}"]`)?.classList.add('loaded');
                
                displayData(name, data);
                updateLoadedTables();
                setStatus(`Loaded ${name}`, 'connected');
                
                // Register with AlaSQL
                registerWithSQL(name, data);
                
            } catch (e) {
                setStatus(`Error loading ${name}: ${e.message}`, 'error');
                console.error(e);
            }
        }

        function displayData(name, data) {
            const infoEl = document.getElementById('data-info');
            const viewerEl = document.getElementById('json-viewer');
            
            // Info summary
            let recordCount = 'N/A';
            if (Array.isArray(data)) recordCount = data.length;
            else if (data.records) recordCount = data.records.length;
            else if (data.data) recordCount = data.data.length;
            else if (data.features) recordCount = data.features.length;
            
            infoEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <h3 style="color: white; margin-bottom: 5px;">${name}</h3>
                        <p style="color: var(--gray-500); font-size: 0.875rem;">
                            Records: ${typeof recordCount === 'number' ? recordCount.toLocaleString() : recordCount} | 
                            Type: ${Array.isArray(data) ? 'Array' : 'Object'}
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="downloadData('${name}')">Download JSON</button>
                        <button class="btn btn-primary" onclick="loadIntoSQL('${name}')">Use in SQL</button>
                    </div>
                </div>
            `;
            
            // JSON viewer
            viewerEl.innerHTML = renderJSON(data, 0, true);
        }

        function renderJSON(data, depth = 0, isRoot = false) {
            if (depth > 50) return '<span class="json-null">...</span>';
            
            if (data === null) return '<span class="json-null">null</span>';
            if (typeof data === 'boolean') return `<span class="json-boolean">${data}</span>`;
            if (typeof data === 'number') return `<span class="json-number">${data}</span>`;
            if (typeof data === 'string') return `<span class="json-string">"${escapeHtml(data.substring(0, 500))}${data.length > 500 ? '...' : ''}"</span>`;
            
            if (Array.isArray(data)) {
                if (data.length === 0) return '<span class="json-bracket">[]</span>';
                
                const collapsed = depth > 1 && !isRoot;
                const preview = data.length > 5 ? ` (${data.length} items)` : '';
                
                let html = `<span class="json-collapsible ${collapsed ? 'collapsed' : ''}" onclick="this.classList.toggle('collapsed')">Array${preview}</span>`;
                html += '<span class="json-bracket">[</span>';
                html += '<div class="json-children">';
                
                const maxItems = Math.min(data.length, 100);
                for (let i = 0; i < maxItems; i++) {
                    html += `<div><span class="json-key">${i}:</span> ${renderJSON(data[i], depth + 1)}</div>`;
                }
                if (data.length > 100) {
                    html += `<div><span class="json-null">... ${data.length - 100} more items</span></div>`;
                }
                
                html += '</div>';
                html += '<span class="json-bracket">]</span>';
                return html;
            }
            
            if (typeof data === 'object') {
                const keys = Object.keys(data);
                if (keys.length === 0) return '<span class="json-bracket">{}</span>';
                
                const collapsed = depth > 1 && !isRoot;
                const preview = keys.length > 3 ? ` (${keys.length} keys)` : '';
                
                let html = `<span class="json-collapsible ${collapsed ? 'collapsed' : ''}" onclick="this.classList.toggle('collapsed')">Object${preview}</span>`;
                html += '<span class="json-bracket">{</span>';
                html += '<div class="json-children">';
                
                keys.slice(0, 50).forEach(key => {
                    html += `<div><span class="json-key">"${escapeHtml(key)}":</span> ${renderJSON(data[key], depth + 1)}</div>`;
                });
                if (keys.length > 50) {
                    html += `<div><span class="json-null">... ${keys.length - 50} more keys</span></div>`;
                }
                
                html += '</div>';
                html += '<span class="json-bracket">}</span>';
                return html;
            }
            
            return String(data);
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // ============================================
        // SQL FUNCTIONALITY
        // ============================================
        function registerWithSQL(name, data) {
            // Flatten data for SQL if needed
            let tableData = data;
            
            if (data.records) tableData = data.records;
            else if (data.data) tableData = data.data;
            else if (data.features) tableData = data.features.map(f => ({ ...f.properties, geometry: f.geometry }));
            else if (data.annual_data) tableData = data.annual_data;
            
            if (Array.isArray(tableData)) {
                alasql(`DROP TABLE IF EXISTS ${name}`);
                alasql(`CREATE TABLE ${name}`);
                alasql.tables[name].data = tableData;
            }
        }

        function runSQL() {
            const query = state.sqlEditor.getValue();
            const resultsEl = document.getElementById('sql-results');
            
            try {
                const result = alasql(query);
                state.lastSqlResult = result;
                
                if (Array.isArray(result) && result.length > 0) {
                    resultsEl.innerHTML = renderSQLTable(result);
                } else if (result !== undefined) {
                    resultsEl.innerHTML = `<p style="color: var(--success);">Query executed. Result: ${JSON.stringify(result)}</p>`;
                } else {
                    resultsEl.innerHTML = `<p style="color: var(--gray-500);">Query executed. No results.</p>`;
                }
                
                setStatus(`Query returned ${Array.isArray(result) ? result.length : 1} rows`, 'connected');
            } catch (e) {
                resultsEl.innerHTML = `<p style="color: #fca5a5;">Error: ${e.message}</p>`;
                setStatus('Query error', 'error');
            }
        }

        function renderSQLTable(data) {
            if (!data || data.length === 0) return '<p>No results</p>';
            
            const keys = Object.keys(data[0]);
            let html = `<p style="color: var(--gray-500); margin-bottom: 10px;">${data.length} rows</p>`;
            html += '<table class="results-table"><thead><tr>';
            
            keys.forEach(key => {
                html += `<th>${escapeHtml(key)}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.slice(0, 1000).forEach(row => {
                html += '<tr>';
                keys.forEach(key => {
                    let val = row[key];
                    if (typeof val === 'object') val = JSON.stringify(val).substring(0, 100);
                    if (typeof val === 'number' && val > 1000) val = val.toLocaleString();
                    html += `<td>${escapeHtml(String(val ?? ''))}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            if (data.length > 1000) {
                html += `<p style="color: var(--warning); margin-top: 10px;">Showing first 1000 of ${data.length} rows</p>`;
            }
            
            return html;
        }

        function toggleTemplates() {
            document.getElementById('templates-menu').classList.toggle('show');
        }

        function useTemplate(name) {
            if (SQL_TEMPLATES[name]) {
                state.sqlEditor.setValue(SQL_TEMPLATES[name]);
            }
            toggleTemplates();
        }

        function updateLoadedTables() {
            const tables = Object.keys(state.loadedData);
            document.getElementById('loaded-tables').textContent = tables.length ? tables.join(', ') : 'none';
        }

        function loadIntoSQL(name) {
            // Switch to SQL tab
            document.querySelector('[data-tab="sql"]').click();
            state.sqlEditor.setValue(`-- Querying ${name}\nSELECT * FROM ${name} LIMIT 100`);
        }

        // ============================================
        // PYTHON NOTEBOOK
        // ============================================
        let cellIdCounter = 0;

        function addInitialCell() {
            addCell(`# Welcome to the Python Playground
# Available functions:
#   load_data('table_name') - Load a dataset as DataFrame
#   show(df) - Display a DataFrame
#
# Example:
# df = load_data('real_estate_ownership_analysis')
# print(df.keys())

print("Python ready! Load data from the sidebar to begin.")`);
        }

        function addCell(code = '') {
            const id = `cell-${cellIdCounter++}`;
            const container = document.getElementById('notebook-container');
            
            const cellEl = document.createElement('div');
            cellEl.className = 'cell';
            cellEl.id = id;
            cellEl.innerHTML = `
                <div class="cell-toolbar">
                    <span class="cell-type">Python</span>
                    <div class="cell-actions">
                        <button class="cell-btn run" onclick="runCell('${id}')">‚ñ∂ Run</button>
                        <button class="cell-btn" onclick="moveCell('${id}', -1)">‚Üë</button>
                        <button class="cell-btn" onclick="moveCell('${id}', 1)">‚Üì</button>
                        <button class="cell-btn" onclick="deleteCell('${id}')">‚úï</button>
                    </div>
                </div>
                <div class="cell-editor" id="${id}-editor"></div>
                <div class="cell-output" id="${id}-output"></div>
            `;
            
            // Insert before add button or at end
            const addBtn = container.querySelector('.add-cell-btn');
            if (addBtn) {
                container.insertBefore(cellEl, addBtn);
            } else {
                container.appendChild(cellEl);
                
                // Add the "Add Cell" button if not present
                const addBtnEl = document.createElement('div');
                addBtnEl.className = 'add-cell-btn';
                addBtnEl.onclick = () => addCell();
                addBtnEl.innerHTML = '<span>+ Add Cell</span>';
                container.appendChild(addBtnEl);
            }
            
            // Initialize Monaco editor for this cell
            require(['vs/editor/editor.main'], function() {
                state.cellEditors[id] = monaco.editor.create(document.getElementById(`${id}-editor`), {
                    value: code,
                    language: 'python',
                    theme: 'vs-dark',
                    minimap: { enabled: false },
                    fontSize: 14,
                    lineNumbers: 'on',
                    scrollBeyondLastLine: false,
                    automaticLayout: true,
                    lineHeight: 20
                });
                
                // Auto-resize based on content
                const updateHeight = () => {
                    const lineCount = state.cellEditors[id].getModel().getLineCount();
                    const height = Math.max(100, Math.min(400, lineCount * 20 + 20));
                    document.getElementById(`${id}-editor`).style.height = height + 'px';
                    state.cellEditors[id].layout();
                };
                
                state.cellEditors[id].onDidChangeModelContent(updateHeight);
                updateHeight();
                
                // Ctrl+Enter to run
                state.cellEditors[id].addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => runCell(id));
            });
            
            state.cells.push(id);
        }

        async function runCell(id) {
            if (!state.pythonReady) {
                alert('Python is still loading. Please wait.');
                return;
            }
            
            const code = state.cellEditors[id]?.getValue() || '';
            const outputEl = document.getElementById(`${id}-output`);
            
            outputEl.className = 'cell-output';
            outputEl.textContent = 'Running...';
            
            try {
                // Capture stdout
                await state.pyodide.runPythonAsync(`
import sys
from io import StringIO
_stdout = sys.stdout
sys.stdout = StringIO()
                `);
                
                // Run the code
                const result = await state.pyodide.runPythonAsync(code);
                
                // Get stdout
                const stdout = await state.pyodide.runPythonAsync(`
_output = sys.stdout.getvalue()
sys.stdout = _stdout
_output
                `);
                
                let output = stdout || '';
                if (result !== undefined && result !== null) {
                    output += (output ? '\n' : '') + String(result);
                }
                
                outputEl.textContent = output || '(no output)';
                
            } catch (e) {
                outputEl.className = 'cell-output error';
                outputEl.textContent = e.message;
            }
        }

        async function runAllCells() {
            for (const id of state.cells) {
                await runCell(id);
            }
        }

        function deleteCell(id) {
            if (state.cells.length <= 1) {
                alert('Cannot delete the last cell');
                return;
            }
            
            const el = document.getElementById(id);
            if (el) el.remove();
            
            if (state.cellEditors[id]) {
                state.cellEditors[id].dispose();
                delete state.cellEditors[id];
            }
            
            state.cells = state.cells.filter(c => c !== id);
        }

        function moveCell(id, direction) {
            const idx = state.cells.indexOf(id);
            const newIdx = idx + direction;
            
            if (newIdx < 0 || newIdx >= state.cells.length) return;
            
            // Swap in array
            [state.cells[idx], state.cells[newIdx]] = [state.cells[newIdx], state.cells[idx]];
            
            // Swap in DOM
            const container = document.getElementById('notebook-container');
            const el = document.getElementById(id);
            const siblingId = state.cells[idx]; // The one that was swapped
            const siblingEl = document.getElementById(siblingId);
            
            if (direction < 0) {
                container.insertBefore(el, siblingEl);
            } else {
                container.insertBefore(siblingEl, el);
            }
        }

        function clearOutputs() {
            state.cells.forEach(id => {
                const outputEl = document.getElementById(`${id}-output`);
                if (outputEl) outputEl.textContent = '';
            });
        }

        // ============================================
        // SAVE/LOAD
        // ============================================
        function saveNotebook() {
            const notebook = {
                version: 1,
                timestamp: new Date().toISOString(),
                cells: state.cells.map(id => ({
                    id,
                    code: state.cellEditors[id]?.getValue() || '',
                    output: document.getElementById(`${id}-output`)?.textContent || ''
                })),
                sql: state.sqlEditor?.getValue() || '',
                loadedData: Object.keys(state.loadedData)
            };
            
            const blob = new Blob([JSON.stringify(notebook, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `notebook-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            setStatus('Notebook saved', 'connected');
        }

        function loadNotebook() {
            document.getElementById('notebook-file-input').click();
        }

        function handleNotebookUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const notebook = JSON.parse(e.target.result);
                    
                    // Clear existing cells
                    state.cells.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.remove();
                        if (state.cellEditors[id]) state.cellEditors[id].dispose();
                    });
                    state.cells = [];
                    state.cellEditors = {};
                    
                    // Remove add button temporarily
                    const container = document.getElementById('notebook-container');
                    container.innerHTML = '';
                    
                    // Recreate cells
                    notebook.cells.forEach(cell => {
                        addCell(cell.code);
                    });
                    
                    // Restore SQL
                    if (notebook.sql && state.sqlEditor) {
                        state.sqlEditor.setValue(notebook.sql);
                    }
                    
                    setStatus('Notebook loaded', 'connected');
                } catch (e) {
                    alert('Failed to load notebook: ' + e.message);
                }
            };
            reader.readAsText(file);
        }

        function downloadData(name) {
            const data = state.loadedData[name];
            if (!data) return;
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
        }

        // ============================================
        // UTILITY
        // ============================================
        function setStatus(message, type = 'normal') {
            document.getElementById('status-text').textContent = message;
            const dot = document.getElementById('status-dot');
            dot.className = 'status-dot';
            if (type === 'connected') dot.classList.add('connected');
        }

        // Close dropdowns on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.templates-dropdown')) {
                document.getElementById('templates-menu')?.classList.remove('show');
            }
        });
    </script>
</body>
</html>
